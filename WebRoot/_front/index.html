<!DOCTYPE html">
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta charset="utf-8">
        <title>点儿</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta content="telephone=no" name="format-detection">
        <link rel="stylesheet" href="${base}/css/style.css">
        <% include("common/common.html"){} %>
    </head>
    <body>
    	<input type="hidden" id="openId" value="${userInfo.openid}"/>
    	<input type="hidden" id="nick" value="${userInfo.nickname}"/>
    	<input type="hidden" id="head" value="${userInfo.headimgurl}"/>
        <section>
            <div class="downhea">
                <img src="${base}/img/logo.png"  width="131" alt="">
                <a href="" title="" class="downbtn" id="js-down">下载苹果版</a>
            </div>
            <div class="list">
                <span class="phb">排行榜</span>
                <ul>
                    <%
					    for(indexR in indexRanks){
					    if(indexRLP.index<=3){
					%>
					    <li>
					    	<div class="listcon">
	                            <div class="frcon">
	                                <h3>${indexR.nick}</h3>
	                                <p>共赚 <em>${indexR.money}</em> 元</p>
	                            </div>
	                            <i class="nume">${indexRLP.index}</i>
	                            <img src="${indexR.pUrl}" alt="">
	                        </div>
	                     </li>
					<%}}%>
                    
                </ul>
            </div>
            <div class="tasklist">
                <ul>
                	<%
					    for(rank in ranks ){
					%>
						
					    <li data-time="${rank.cTime}">
	                        <div class="taskcon">
	                            <img src="${rank.pUrl}" alt="">
	                            <div class="detail">
	                                <h4>${rank.nick} <span> ${parseInt(rank.stri)}秒前 </span></h4>
	                                <p class="con1">完成：${rank.jj}</p>
	                                <p class="con2">共赚 <em>${rank.money}</em> 元</p>
	                            </div>
	                        </div>
	                    </li>
					<%}%>
                </ul>
            </div>

        </section>
        <script src="${base}/js/jquery-1.9.1.min.js"></script>
        <script src="${base}/js/velocity.min.js"></script>
        <script src="${base}/js/layer.m.js"></script>
        <!-- <script src="${base}/js/NewsRefresh.js"></script> -->
        <script type="text/javascript">
        var report_domain = "http://119.29.75.90:8001";
        $(function(){
  			
            $("#js-down").click(function() {
                var pagei = layer.open({
                    type: 1,
                    content: '<button class="layermend"></button><h4 class="ctit">有\“钥匙\”才能开启哦</h4><a class="cbtn login_btn" href="${base}/wx/xzxd">安装钥匙（新用户送1元）</a><a class="cbtn" href="javascript:void(0);">已安装钥匙点此登录</a>',
                    style: 'width:260px; height:210px;',
                    success: function(olayer){
                        olayer.getElementsByClassName('layermend')[0].onclick = function(){
                            layer.close(pagei);
                        };
                        /* olayer.getElementById('clickLogin'); */
                        olayer.getElementsByClassName('cbtn')[1].onclick = function(){
                        	/* 请求idfa手机唯一标识。 */
                        	$.ajax({
                                url: "http://127.0.0.1:54321/idfa?op=1&callback=?",
                                type: "get",
                                dataType: "jsonp",
                                jsonp:'callback', 
                				jsonpCallback:'jsonpCallBack',
                				cache:false
                           });
                        }
                    }
                });
                return false;
            });
            /* $.NewsRefresh.init({
                url : '${base}/wx/ajaxInitMsgPhb',
                lastId : 0,
                total : 8,
                current : 8 
            }).start(); */ 
           
        });
        /* 微信分享上报 */
        window.onload = function(){
        		var openId = document.getElementById("openId").value;
        		var hrefurl=window.location.href;
        		var newHref = hrefurl.split("?")[0];
        		var titleName = "赚钱！从小点儿开始！";
        		wx.ready(function() {
					/* 分享到朋友圈 */
					wx.onMenuShareTimeline({
				      title: titleName,
				      link: newHref,
				      imgUrl: '',
				      trigger: function (res) {
				        /* 不要尝试在trigger中使用ajax异步请求修改本次分享的内容，因为客户端分享操作是一个同步操作，这时候使用ajax的回包会还没有返回 */
				        alert('用户点击分享到朋友圈');
				      },
				      success: function (res) {
				      	alert('已分享到朋友圈');
				      	$.ajax({
							url: report_domain + "/sh/report?callback=jsonpCallBack1",
							type:'GET',
							dataType:'jsonp',
							jsonp:'callback',
							data:"openid="+openId+"&type=1",
							cache:false
						});
				        
				      },
				      cancel: function (res) {
				        alert('已取消');
				      },
				      fail: function (res) {
				        alert(JSON.stringify(res));
				      }
				    });
				    /* 分享到微信朋友 */
				    wx.onMenuShareAppMessage({
					    title: titleName,
				      	link: newHref,
					    imgUrl: '', /*  分享图标 */
					    success: function (res) { 
					    	alert('已分享给朋友');
					        /* 用户确认分享后执行的回调函数 */
					        $.ajax({
								url:report_domain + "/sh/report?callback=jsonpCallBack1",
								type:'GET',
								dataType:'jsonp',
								jsonp:'callback',
								data:"openid="+openId+"&type=1",
								cache:false
							});
					    },
					    cancel: function (res) { 
					    	alert('已取消');
					        
					/* 用户取消分享后执行的回调函数 */
					    }
					});
					/* 分享到QQ */
				    wx.onMenuShareQQ({
					    title: titleName, /* 分享标题 */
					    link: newHref, /* 分享链接 */
					    imgUrl: '', /* 分享图标 */
					    success: function (res) { 
					    	alert('已分享到QQ');
					       /* 用户确认分享后执行的回调函数 */
					       $.ajax({
								url:report_domain + "/sh/report?callback=jsonpCallBack1",
								type:'GET',
								dataType:'jsonp',
								jsonp:'callback',
								data:"openid="+openId+"&type=2",
								cache:false
							});
					    },
					    cancel: function (res) { 
					    	alert('已取消');
					       /* 用户取消分享后执行的回调函数 */
					    }
					});
			 });
		}
        
		/* 上报回调函数 */
		function jsonpCallBack1(data){
			if(data.isok==1){
				layer.open({
                       content: '分享成功！',
                       style:'color:#ff6634',
                       btn: ['确定']
                   });
                   return false;
			}else{
				layer.open({
                       content: '分享失败！',
                       style:'color:#ff6634',
                       btn: ['确定']
                   });
                   return false;
			}
		}
        
		
		function jsonpCallBack(data){
			if(typeof(data) == "undefined")
        	{
        		alert('点儿未安装或者未启动！');
        	}else{
        		/* 获取到idfa ; */
        		if(data.ok == 1){
        			var idfa = data.idfa ;
        			if(idfa == null || idfa == ''  )
        			{
        				alert('点儿检测手机配置失败！');
        				return ;
        			}
        			var openId = document.getElementById("openId").value;
    				var nick = document.getElementById("nick").value;
    				var head = document.getElementById("head").value;
    				/* alert("openid:"+openId+"--nick:"+nick+"--head:"+head); */
    				/* 上报用户或更新数据 */
                	$.ajax({
                        url: report_domain + "/wx/sv?op=1&callback=?",
                        type: "get",
                        data: 'openid='+openId +'&nick='+nick+'&pUrl='+head+'&idfa='+idfa+'&idfv=10',
                        dataType: "jsonp",
                        jsonp:'callback', 
        				jsonpCallback:'jsonpCallBack004',
        				cache:false
                   });
    				
                	/* 上报活跃 */
                	$.ajax({
                        url: report_domain + "/app/report?op=1&callback=?",
                        type: "get",
                        data: 'openid='+openId +'&type=1',
                        dataType: "jsonp",
                        jsonp:'callback', 
        				jsonpCallback:'jsonpCallBack005',
        				cache:false
                   });
    			   
                   window.location.href = "${base}/wx/rwzq";
        		}else{
        			alert('点儿验证信息失败！');
        		}
        		
        	}
		}
        </script>
    </body>
</html>
