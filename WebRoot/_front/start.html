<#compress>
<!DOCTYPE html">
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta charset="utf-8">
        <title>开始赚钱</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta content="telephone=no" name="format-detection">
        <link rel="stylesheet" href="${base}/css/style.css">
        <% include("common/common.html"){} %>
        <script type="text/javascript">
          var report_domain = "http://119.29.75.90:8001";
        	window.onload = function(){
        		var openId = document.getElementById("openId").value;
        		var hrefurl=window.location.href;
        		var newHref = hrefurl.split("?")[0];
        		wx.ready(function() {
					/*分享到朋友圈*/
					wx.onMenuShareTimeline({
				      title: '开始赚钱',
				      link: newHref,
				      imgUrl: '',
				      trigger: function (res) {
				        /* 不要尝试在trigger中使用ajax异步请求修改本次分享的内容，因为客户端分享操作是一个同步操作，这时候使用ajax的回包会还没有返回*/
				        alert('用户点击分享到朋友圈');
				      },
				      success: function (res) {
				      	alert('已分享到朋友圈');
				      	$.ajax({
							url:report_domain +"/sh/report?callback=jsonpCallBack",
							type:'GET',
							dataType:'jsonp',
							jsonp:'callback',
							data:"openid="+openId+"&type=1",
							cache:false
						});
				        
				      },
				      cancel: function (res) {
				        alert('已取消');
				      },
				      fail: function (res) {
				        alert(JSON.stringify(res));
				      }
				    });
				    /*分享到微信朋友*/
				    wx.onMenuShareAppMessage({
					    title: '开始赚钱',
				      	link: newHref,
					    imgUrl: '', /*分享图标*/
					    success: function (res) { 
					    	alert('已分享给朋友');
					        /*用户确认分享后执行的回调函数*/
					        $.ajax({
								url:report_domain +"/sh/report?callback=jsonpCallBack",
								type:'GET',
								dataType:'jsonp',
								jsonp:'callback',
								data:"openid="+openId+"&type=1",
								cache:false
							});
					    },
					    cancel: function (res) { 
					    	alert('已取消');
					    }
					});
					/*分享到QQ*/
				    wx.onMenuShareQQ({
					    title: '开始赚钱', /* 分享标题*/
					    /* //desc: '',  分享描述  */
					    link: newHref, /*分享链接 */
					    imgUrl: '', // 分享图标
					    success: function (res) { 
					    	alert('已分享到QQ');
					       /* 用户确认分享后执行的回调函数 */
					       $.ajax({
								url:report_domain +"/sh/report?callback=jsonpCallBack",
								type:'GET',
								dataType:'jsonp',
								jsonp:'callback',
								data:"openid="+openId+"&type=2",
								cache:false
							});
					    },
					    cancel: function (res) { 
					    	alert('已取消');
					    }
					});
        		});
        	}
        	/* 上报回调函数 */
			function jsonpCallBack(data){
				alert(data);
			}
        </script>
    </head>
    <body class="bge">
    	<input type="hidden" id="openId" value="${session.wxinfo.openid}"/>
    	<input type="hidden" id="headimgurl" value="${session.wxinfo.headimgurl}"/>
    	<input type="hidden" id="nickname" value="${session.wxinfo.nickname}"/>
        <ul class="swlist">
        	<%for(ad in adList){%>
        		<li>
                <a href="${base}/wx/prodetail?id=${ad.id}&openId=${session.wxinfo.openid}" title="${ad.id}">
                	<img src="${ad.pUrl}" height="50" width="50" alt="">
                	<P class="tleft">
                		<span class="ftbig">${ad.name}</span> <br>
                		<span class="deta">${ad.jhjj}</span>
                	</P>
                	<span class="swbtn">+${ad.price}元</span>
               </a>
            </li>
        	<%}%>
        </ul>
        <script src="${base}/js/jquery-1.9.1.min.js"></script>
        <script src="${base}/js/layer.m.js"></script>
        <script type="text/javascript">
        var has_idfa = '';
        var report_domain = "http://119.29.75.90:8001";
        $(function(){
	        var openId = document.getElementById("openId").value;
	        $(".swlist a").click(function(){
	        	/*  广告id */
	        	var id = this.title;
	        	
            	/*  点击广告上报广告展示 */
	        	$.ajax({
					url:"http://119.29.75.90:8001/ad/report",
					type:'GET',
					dataType:'jsonp',
					jsonp:'callback',
					data:"openid="+openId+"&adid="+id+"&type=1",
					cache:false
				});
            	
	        	reportClick(openId,id);
	        });
	        
	       /*  请求idfa手机唯一标识。 */
        	$.ajax({
                url: "http://127.0.0.1:54321/idfa?op=1&callback=?",
                type: "get",
                dataType: "jsonp",
                jsonp:'callback', 
				jsonpCallback:'jsonpCallBack',
				cache:false
           });
	        setTimeout("checkIdfa()", 1000);
       }); 
     	/*  上报回调函数 */
		function jsonpCallBack(data){
        	if(typeof(data) == "undefined")
        	{
        		alert('点儿未安装或者未启动！');
        	}else{
        		/* 获取到idfa */
        		if(data.ok == 1){
        			var idfa = data.idfa ;
        			has_idfa = data.idfa ;
        			if(idfa == null || idfa == ''  )
        			{
        				alert('点儿检测手机配置失败！');
        				return ;
        			}
        		}else{
        			alert('点儿验证信息失败！');
        		}
        		
        	}
        }
     	
     	function reportClick(openId,id){
     		if(has_idfa != ''){
        		/* 上报点击 */
            	$.ajax({
                    url: report_domain + "/ad/click?op=1&callback=?",
                    type: "get",
                    data: 'openid='+openId +'&idfa='+has_idfa+'&adid='+id,
                    dataType: "jsonp",
                    jsonp:'callback', 
    				jsonpCallback:'jsonpCallBack006',
    				cache:false
               });
        	}
     	}
		function checkIdfa(){
    		 if(has_idfa == null || has_idfa == ''){
    			var pagei = layer.open({
	                type: 1,
	                content: '<button class="layermend"></button><h4 class="ctit">有\“钥匙\”才能开启哦</h4><a class="cbtn login_btn" href="${base}/wx/xzxd">安装钥匙（新用户送1元）</a><a class="cbtn" href="javascript:void(0);">已安装钥匙点此登录</a>',
	                style: 'width:260px; height:210px;',
	                success: function(olayer){
	                    olayer.getElementsByClassName('layermend')[0].onclick = function(){
	                        layer.close(pagei);
	                    };
	                    /*olayer.getElementById('clickLogin'); */
	                    olayer.getElementsByClassName('cbtn')[1].onclick = function(){
	                       layer.close(pagei);
	                    }
	                }
	            });
    		}else{
    			var openId = document.getElementById("openId").value;
				var nick = document.getElementById("nickname").value;
				var head = document.getElementById("headimgurl").value;
				/* alert("openid:"+openId+"--nick:"+nick+"--head:"+head+"--idfa:"+has_idfa); */
				/*上报用户或更新数据 */
            	$.ajax({
                    url: report_domain + "/wx/sv?op=1&callback=?",
                    type: "get",
                    data: 'openid='+openId +'&nick='+nick+'&pUrl='+head+'&idfa='+has_idfa+'&idfv=10',
                    dataType: "jsonp",
                    jsonp:'callback', 
    				jsonpCallback:'jsonpCallBack004',
    				cache:false
               });
				
            	/*上报活跃 */
            	$.ajax({
                    url: report_domain + "/app/report?op=1&callback=?",
                    type: "get",
                    data: 'openid='+openId +'&type=2',
                    dataType: "jsonp",
                    jsonp:'callback', 
    				jsonpCallback:'jsonpCallBack005',
    				cache:false
               });
            
    		}
    		
    	}
     	
     	
        </script>
    </body>
</html>
</#compress>